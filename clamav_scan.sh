#!/bin/bash

# Configuration data
LOG_DIR="/tmp/logs/$(date +%Y-%m-%d)"
CLAMAV_LOG_FILE="$LOG_DIR/clamav_scan.log"
MALDET_LOG_FILE="$LOG_DIR/maldet_scan.log"
ERROR_LOG_FILE="$LOG_DIR/error.log"
HOSTNAME=$(hostname)
SERVER_IP=$(hostname -I | awk '{print $1}')
CHAT_ID="${CHAT_ID:-"-1002317051732"}"
BOT_TOKEN="${BOT_TOKEN:-"7771335446:AAG8HEg0ifpuwm0pV3FM9HaJSHMrfHy1VC0"}"
MESSAGE_THREAD_ID="${MESSAGE_THREAD_ID:-"31"}"
SCAN_DIRECTORIES=("/var/www" "/home" "/opt" "/srv" "/usr/local" "/etc/nginx" "/etc/apache2")
MAX_PARALLEL_SCANS=3  # Max parallel scans

# Create directory for logs
mkdir -p "$LOG_DIR"

# Function to send Telegram messages
send_telegram_message() {
    local message="$1"
    local response
    response=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
        -d chat_id="${CHAT_ID}" \
        -d text="$message" \
        -d parse_mode="Markdown" \
        -d thread_id="${MESSAGE_THREAD_ID}")

    # Log error if message sending fails
    if [[ ! $response == *'"ok":true'* ]]; then
        echo "Error sending message to Telegram: $response" >> "$ERROR_LOG_FILE"
    fi
}

# Function to check and update the script without sha256sum
update_script() {
    SCRIPT_URL="https://github.com/isa-dagestani/MalwareScan/raw/main/clamav_scan.sh"
    echo "Checking for script updates..."

    curl -s -L "$SCRIPT_URL" -o /tmp/updated_script.sh

    # Check if downloaded file is a valid shell script
    if file /tmp/updated_script.sh | grep -q "shell script"; then
        # Compare current script with downloaded script using diff
        if ! diff "$0" /tmp/updated_script.sh &> /dev/null; then
            echo "New version found. Executing updated script..."
            chmod +x /tmp/updated_script.sh
            exec /tmp/updated_script.sh
            exit 0
        else
            echo "Script is up-to-date."
        fi
    else
        echo "Error: Downloaded file is not a valid shell script. Update aborted." >> "$ERROR_LOG_FILE"
    fi
}

# Function to perform parallel scans with a limit on simultaneous scans
run_parallel_scans() {
    echo "Starting ClamAV and Maldet scans with parallel limit $MAX_PARALLEL_SCANS..."
    count=0
    for dir in "${SCAN_DIRECTORIES[@]}"; do
        if [ -d "$dir" ]; then
            echo "Scanning directory: $dir"
            sudo clamscan -r --infected --detect-pua=yes --heuristic-alerts=yes "$dir" | tee -a "$CLAMAV_LOG_FILE" &
            sudo maldet -a "$dir" >> "$MALDET_LOG_FILE" 2>&1 &
            count=$((count + 2))
            if [ "$count" -ge "$MAX_PARALLEL_SCANS" ]; then
                wait -n
                count=$((count - 2))
            fi
        else
            echo "Directory $dir does not exist, skipping..." >> "$ERROR_LOG_FILE"
        fi
    done
    wait
}

# Send Telegram notification if threats are detected
send_reports_if_threats() {
    clamav_found=$(grep -c "FOUND" "$CLAMAV_LOG_FILE" || echo "0")
    maldet_found=$(grep -c "malware detected" "$MALDET_LOG_FILE" || echo "0")

    if [ "$clamav_found" -gt 0 ]; then
        report=$(grep "FOUND" "$CLAMAV_LOG_FILE" | awk -F ':' '{print $1}')
        message="*‚ö†Ô∏è Virus Detected by ClamAV ‚ö†Ô∏è* | *Server:* \`$HOSTNAME\` | *IP:* \`$SERVER_IP\` | *Files Detected:* $clamav_found \nüö® \`\`\`$report\`\`\`"
        send_telegram_message "$message"
    fi

    if [ "$maldet_found" -gt 0 ]; then
        report=$(grep "malware detected" "$MALDET_LOG_FILE")
        message="*‚ö†Ô∏è Malware Detected by Maldet ‚ö†Ô∏è* | *Server:* \`$HOSTNAME\` | *IP:* \`$SERVER_IP\` | *Malware Detected:* $maldet_found \nüö® \`\`\`$report\`\`\`"
        send_telegram_message "$message"
    fi
}

# Function to clean up old logs
archive_and_cleanup_logs() {
    find "$‚Äã‚¨§